<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zai.booking.mapper.BookingLogMapper">
    
    <resultMap id="BookingLogResultMap" type="com.zai.booking.entity.BookingLog">
        <id column="booking_log_id" property="bookingLogId"/>
        <result column="booking_id" property="bookingId"/>
        <result column="version" property="version"/>
        <result column="operation" property="operation"/>
        <result column="operator" property="operator"/>
        <result column="operator_name" property="operatorName"/>
        <result column="operate_time" property="operateTime"/>
        <result column="booking_snapshot" property="bookingSnapshot"/>
        <result column="change_summary" property="changeSummary"/>
    </resultMap>

    <sql id="Base_Column_List">
        booking_log_id, booking_id, version, operation, operator, operate_time, 
        booking_snapshot, change_summary
    </sql>

    <insert id="insert" parameterType="com.zai.booking.entity.BookingLog">
        INSERT INTO bookings_log (
            <include refid="Base_Column_List"/>
        ) VALUES (
            #{bookingLogId}, #{bookingId}, #{version}, #{operation}, #{operator}, 
            #{operateTime}, #{bookingSnapshot}, #{changeSummary}
        )
    </insert>

    <delete id="deleteByBookingLogId" parameterType="java.lang.String">
        DELETE FROM bookings_log WHERE booking_log_id = #{bookingLogId}
    </delete>

    <delete id="deleteByBookingId" parameterType="java.lang.String">
        DELETE FROM bookings_log WHERE booking_id = #{bookingId}
    </delete>

    <update id="update" parameterType="com.zai.booking.entity.BookingLog">
        UPDATE bookings_log
        <set>
            <if test="bookingId != null">booking_id = #{bookingId},</if>
            <if test="version != null">version = #{version},</if>
            <if test="operation != null">operation = #{operation},</if>
            <if test="operator != null">operator = #{operator},</if>
            <if test="operateTime != null">operate_time = #{operateTime},</if>
            <if test="bookingSnapshot != null">booking_snapshot = #{bookingSnapshot},</if>
            <if test="changeSummary != null">change_summary = #{changeSummary},</if>
        </set>
        WHERE booking_log_id = #{bookingLogId}
    </update>

    <select id="selectByBookingLogId" resultMap="BookingLogResultMap">
        SELECT 
            bl.booking_log_id, bl.booking_id, bl.version, bl.operation, bl.operator,
            u.username as operator_name, bl.operate_time, bl.booking_snapshot, bl.change_summary
        FROM bookings_log bl
        LEFT JOIN users u ON bl.operator = u.user_id
        WHERE bl.booking_log_id = #{bookingLogId}
    </select>

    <select id="selectByBookingId" resultMap="BookingLogResultMap">
        SELECT 
            bl.booking_log_id, bl.booking_id, bl.version, bl.operation, bl.operator,
            u.username as operator_name, bl.operate_time, bl.booking_snapshot, bl.change_summary
        FROM bookings_log bl
        LEFT JOIN users u ON bl.operator = u.user_id
        WHERE bl.booking_id = #{bookingId}
        ORDER BY bl.operate_time DESC
    </select>

    <select id="selectByBookingIdAndOperation" resultMap="BookingLogResultMap">
        SELECT 
            bl.booking_log_id, bl.booking_id, bl.version, bl.operation, bl.operator,
            u.username as operator_name, bl.operate_time, bl.booking_snapshot, bl.change_summary
        FROM bookings_log bl
        LEFT JOIN users u ON bl.operator = u.user_id
        WHERE bl.booking_id = #{bookingId}
        AND bl.operation = #{operation}
        ORDER BY bl.operate_time DESC
    </select>

    <select id="selectByOperation" resultMap="BookingLogResultMap">
        SELECT 
            bl.booking_log_id, bl.booking_id, bl.version, bl.operation, bl.operator,
            u.username as operator_name, bl.operate_time, bl.booking_snapshot, bl.change_summary
        FROM bookings_log bl
        LEFT JOIN users u ON bl.operator = u.user_id
        WHERE bl.operation = #{operation}
        ORDER BY bl.operate_time DESC
    </select>

    <select id="selectByOperator" resultMap="BookingLogResultMap">
        SELECT 
            bl.booking_log_id, bl.booking_id, bl.version, bl.operation, bl.operator,
            u.full_name as operator_name, bl.operate_time, bl.booking_snapshot, bl.change_summary
        FROM bookings_log bl
        LEFT JOIN users u ON bl.operator = u.user_id
        WHERE bl.operator = #{operator}
        ORDER BY bl.operate_time DESC
    </select>

    <select id="selectAll" resultMap="BookingLogResultMap">
        SELECT 
            bl.booking_log_id, bl.booking_id, bl.version, bl.operation, bl.operator,
            u.username as operator_name, bl.operate_time, bl.booking_snapshot, bl.change_summary
        FROM bookings_log bl
        LEFT JOIN users u ON bl.operator = u.user_id
        ORDER BY bl.operate_time DESC
    </select>

    <select id="selectLatestByBookingId" resultMap="BookingLogResultMap">
        SELECT 
            bl.booking_log_id, bl.booking_id, bl.version, bl.operation, bl.operator,
            u.username as operator_name, bl.operate_time, bl.booking_snapshot, bl.change_summary
        FROM bookings_log bl
        LEFT JOIN users u ON bl.operator = u.user_id
        WHERE bl.booking_id = #{bookingId}
        ORDER BY bl.operate_time DESC
        LIMIT 1
    </select>

</mapper> 