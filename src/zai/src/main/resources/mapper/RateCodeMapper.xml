<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zai.ratecode.mapper.RateCodeMapper">
    <resultMap id="BaseResultMap" type="com.zai.ratecode.entity.RateCode">
        <id column="rate_code_id" property="rateCodeId" jdbcType="VARCHAR"/>
        <result column="chain_id" property="chainId" jdbcType="VARCHAR"/>
        <result column="hotel_id" property="hotelId" jdbcType="VARCHAR"/>
        <result column="rate_code" property="rateCode" jdbcType="VARCHAR"/>
        <result column="rate_code_name" property="rateCodeName" jdbcType="VARCHAR"/>
        <result column="description" property="description" jdbcType="VARCHAR"/>
        <result column="market_code" property="marketCode" jdbcType="VARCHAR"/>
        <result column="channel_id" property="channelId" jdbcType="VARCHAR"/>
        <result column="minlos" property="minlos" jdbcType="INTEGER"/>
        <result column="maxlos" property="maxlos" jdbcType="INTEGER"/>
        <result column="minadv" property="minadv" jdbcType="INTEGER"/>
        <result column="maxadv" property="maxadv" jdbcType="INTEGER"/>
        <result column="limit_start_time" property="limitStartTime" jdbcType="VARCHAR"/>
        <result column="limit_end_time" property="limitEndTime" jdbcType="VARCHAR"/>
        <result column="price_modifier" property="priceModifier" jdbcType="DECIMAL"/>
        <result column="is_percentage" property="isPercentage" jdbcType="BOOLEAN"/>
        <result column="valid_from" property="validFrom" jdbcType="DATE"/>
        <result column="valid_to" property="validTo" jdbcType="DATE"/>
        <result column="reservation_type" property="reservationType" jdbcType="VARCHAR"/>
        <result column="cancellation_type" property="cancellationType" jdbcType="VARCHAR"/>
        <result column="latest_cancellation_days" property="latestCancellationDays" jdbcType="INTEGER"/>
        <result column="latest_cancellation_time" property="latestCancellationTime" jdbcType="VARCHAR"/>
        <result column="cancellable_after_booking" property="cancellableAfterBooking" jdbcType="BOOLEAN"/>
        <result column="order_retention_time" property="orderRetentionTime" jdbcType="VARCHAR"/>
        <result column="stay_start_date" property="stayStartDate" jdbcType="DATE"/>
        <result column="stay_end_date" property="stayEndDate" jdbcType="DATE"/>
        <result column="booking_start_date" property="bookingStartDate" jdbcType="DATE"/>
        <result column="booking_end_date" property="bookingEndDate" jdbcType="DATE"/>
        <result column="created_at" property="createdAt" jdbcType="TIMESTAMP"/>
        <result column="hotel_name" property="hotelName" jdbcType="VARCHAR"/>
        <result column="price_rule_type" property="priceRuleType" jdbcType="VARCHAR"/>
        <result column="parent_rate_code_id" property="parentRateCodeId" jdbcType="VARCHAR"/>        
    </resultMap>

    <sql id="Base_Column_List">
        rate_code_id, chain_id, hotel_id, rate_code, rate_code_name, description,
        market_code, channel_id, minlos, maxlos, minadv, maxadv, limit_start_time,
        limit_end_time, price_modifier, is_percentage, valid_from, valid_to,
        reservation_type, cancellation_type, latest_cancellation_days,
        latest_cancellation_time, cancellable_after_booking, order_retention_time,
        stay_start_date, stay_end_date, booking_start_date, booking_end_date, 
        price_rule_type, parent_rate_code_id, created_at
    </sql>

    <select id="selectByCondition" resultMap="BaseResultMap">
        SELECT
        rc.rate_code_id, rc.chain_id, rc.hotel_id, rc.rate_code, rc.rate_code_name, rc.description,
        rc.market_code, rc.channel_id, rc.minlos, rc.maxlos, rc.minadv, rc.maxadv, rc.limit_start_time,
        rc.limit_end_time, rc.price_modifier, rc.is_percentage, rc.valid_from, rc.valid_to,
        rc.reservation_type, rc.cancellation_type, rc.latest_cancellation_days,
        rc.latest_cancellation_time, rc.cancellable_after_booking, rc.order_retention_time,
        rc.stay_start_date, rc.stay_end_date, rc.booking_start_date, rc.booking_end_date, rc.created_at,
        h.hotel_name, rc.price_rule_type, rc.parent_rate_code_id
        FROM rate_codes rc
        LEFT JOIN hotels h ON rc.hotel_id = h.hotel_id
        <where>
            <if test="hotelId != null">AND rc.hotel_id = #{hotelId}</if>
            <if test="chainId != null">AND rc.chain_id = #{chainId}</if>
            <if test="rateCode != null">
                AND (
                    rc.rate_code LIKE CONCAT('%', #{rateCode}, '%')
                    OR rc.rate_code_name LIKE CONCAT('%', #{rateCode}, '%')
                )
            </if>
        </where>
        ORDER BY rc.created_at DESC
    </select>

    <select id="selectByConditionWithPaging" resultMap="BaseResultMap">
        SELECT
        rc.rate_code_id, rc.chain_id, rc.hotel_id, rc.rate_code, rc.rate_code_name, rc.description,
        rc.market_code, rc.channel_id, rc.minlos, rc.maxlos, rc.minadv, rc.maxadv, rc.limit_start_time,
        rc.limit_end_time, rc.price_modifier, rc.is_percentage, rc.valid_from, rc.valid_to,
        rc.reservation_type, rc.cancellation_type, rc.latest_cancellation_days,
        rc.latest_cancellation_time, rc.cancellable_after_booking, rc.order_retention_time,
        rc.stay_start_date, rc.stay_end_date, rc.booking_start_date, rc.booking_end_date, rc.created_at,
        h.hotel_name, rc.price_rule_type, rc.parent_rate_code_id
        FROM rate_codes rc
        LEFT JOIN hotels h ON rc.hotel_id = h.hotel_id
        <where>
            <if test="hotelId != null">AND rc.hotel_id = #{hotelId}</if>
            <if test="chainId != null">AND rc.chain_id = #{chainId}</if>
            <if test="rateCode != null">
                AND (
                    rc.rate_code LIKE CONCAT('%', #{rateCode}, '%')
                    OR rc.rate_code_name LIKE CONCAT('%', #{rateCode}, '%')
                )
            </if>
        </where>
        ORDER BY rc.rate_code ASC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="countByCondition" resultType="int">
        SELECT COUNT(*)
        FROM rate_codes rc
        LEFT JOIN hotels h ON rc.hotel_id = h.hotel_id
        <where>
            <if test="hotelId != null">AND rc.hotel_id = #{hotelId}</if>
            <if test="chainId != null">AND rc.chain_id = #{chainId}</if>
            <if test="rateCode != null">
                AND (
                    rc.rate_code LIKE CONCAT('%', #{rateCode}, '%')
                    OR rc.rate_code_name LIKE CONCAT('%', #{rateCode}, '%')
                )
            </if>
        </where>
    </select>

    <select id="selectByChainIdAndHotelIdAndRateCode" resultMap="BaseResultMap">
        SELECT
        rc.rate_code_id, rc.chain_id, rc.hotel_id, rc.rate_code, rc.rate_code_name, rc.description,
        rc.market_code, rc.channel_id, rc.minlos, rc.maxlos, rc.minadv, rc.maxadv, rc.limit_start_time,
        rc.limit_end_time, rc.price_modifier, rc.is_percentage, rc.valid_from, rc.valid_to,
        rc.reservation_type, rc.cancellation_type, rc.latest_cancellation_days,
        rc.latest_cancellation_time, rc.cancellable_after_booking, rc.order_retention_time,
        rc.stay_start_date, rc.stay_end_date, rc.booking_start_date, rc.booking_end_date, rc.created_at,
        h.hotel_name, rc.price_rule_type, rc.parent_rate_code_id
        FROM rate_codes rc
        LEFT JOIN hotels h ON rc.hotel_id = h.hotel_id
        <where>
            <if test="hotelId != null">AND rc.hotel_id = #{hotelId}</if>
            <if test="chainId != null">AND rc.chain_id = #{chainId}</if>
            <if test="rateCode != null">AND LOWER(rc.rate_code) = LOWER(#{rateCode})</if>
        </where>
        ORDER BY rc.created_at DESC
    </select>

    <select id="selectListByRateCodeId" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM rate_codes
        WHERE rate_code_id = #{rateCodeId}
    </select>

    <insert id="insert" parameterType="com.zai.ratecode.entity.RateCode">
        INSERT INTO rate_codes (
            rate_code_id, chain_id, hotel_id, rate_code, rate_code_name, description,
            market_code, channel_id, minlos, maxlos, minadv, maxadv, limit_start_time,
            limit_end_time, price_modifier, is_percentage, valid_from, valid_to,
            reservation_type, cancellation_type, latest_cancellation_days,
            latest_cancellation_time, cancellable_after_booking, order_retention_time,
            stay_start_date, stay_end_date, booking_start_date, booking_end_date, 
            price_rule_type, parent_rate_code_id, limit_avail_weeks,created_at,updated_at
        ) VALUES (
            #{rateCodeId}, #{chainId}, #{hotelId}, #{rateCode}, #{rateCodeName}, #{description},
            #{marketCode}, #{channelId}, #{minlos}, #{maxlos}, #{minadv}, #{maxadv}, #{limitStartTime},
            #{limitEndTime}, #{priceModifier}, #{isPercentage}, #{validFrom}, #{validTo},
            #{reservationType}, #{cancellationType}, #{latestCancellationDays},
            #{latestCancellationTime}, #{cancellableAfterBooking}, #{orderRetentionTime},
            #{stayStartDate}, #{stayEndDate}, #{bookingStartDate}, #{bookingEndDate}, 
            #{priceRuleType}, #{parentRateCodeId}, #{limitAvailWeeks}, NOW(), NOW()
        )
    </insert>

    <update id="update" parameterType="com.zai.ratecode.entity.RateCode">
        UPDATE rate_codes
        <set>
            <if test="rateCode != null">rate_code = #{rateCode},</if>
            <if test="rateCodeName != null">rate_code_name = #{rateCodeName},</if>
            <if test="description != null">description = #{description},</if>
            <if test="marketCode != null">market_code = #{marketCode},</if>
            <if test="channelId != null">channel_id = #{channelId},</if>
            <if test="minlos != null">minlos = #{minlos},</if>
            <if test="maxlos != null">maxlos = #{maxlos},</if>
            <if test="minadv != null">minadv = #{minadv},</if>
            <if test="maxadv != null">maxadv = #{maxadv},</if>
            <if test="limitStartTime != null">limit_start_time = #{limitStartTime},</if>
            <if test="limitEndTime != null">limit_end_time = #{limitEndTime},</if>
            <if test="validFrom != null">valid_from = #{validFrom},</if>
            <if test="validTo != null">valid_to = #{validTo},</if>
            <if test="reservationType != null">reservation_type = #{reservationType},</if>
            <if test="cancellationType != null">cancellation_type = #{cancellationType},</if>
            <if test="latestCancellationDays != null">latest_cancellation_days = #{latestCancellationDays},</if>
            <if test="latestCancellationTime != null">latest_cancellation_time = #{latestCancellationTime},</if>
            <if test="cancellableAfterBooking != null">cancellable_after_booking = #{cancellableAfterBooking},</if>
            <if test="orderRetentionTime != null">order_retention_time = #{orderRetentionTime},</if>
            <if test="stayStartDate != null">stay_start_date = #{stayStartDate},</if>
            <if test="stayEndDate != null">stay_end_date = #{stayEndDate},</if>
            <if test="bookingStartDate != null">booking_start_date = #{bookingStartDate},</if>
            <if test="bookingEndDate != null">booking_end_date = #{bookingEndDate},</if>
            updated_at = NOW()
        </set>
        WHERE rate_code_id = #{rateCodeId}
    </update>

    <delete id="deleteByRateCodeId">
        DELETE FROM rate_codes WHERE rate_code_id = #{rateCodeId}
    </delete>

    <select id="selectByRateCodeId" resultType="com.zai.ratecode.entity.RateCode">
        SELECT 
        rc.rate_code_id, rc.chain_id, rc.hotel_id, rc.rate_code, rc.rate_code_name, rc.description,
        rc.market_code, rc.channel_id, rc.minlos, rc.maxlos, rc.minadv, rc.maxadv, rc.limit_start_time,
        rc.limit_end_time, rc.price_modifier, rc.is_percentage, rc.valid_from, rc.valid_to,
        rc.reservation_type, rc.cancellation_type, rc.latest_cancellation_days,
        rc.latest_cancellation_time, rc.cancellable_after_booking, rc.order_retention_time,
        rc.stay_start_date, rc.stay_end_date, rc.booking_start_date, rc.booking_end_date, rc.created_at,
        h.hotel_name, h.hotel_code, rc.price_rule_type, rc.parent_rate_code_id, c.chain_name,c.chain_code
        FROM rate_codes rc
        LEFT JOIN hotels h ON rc.hotel_id = h.hotel_id
        LEFT JOIN chains c ON rc.chain_id = c.chain_id
        WHERE rate_code_id = #{rateCodeId}
        LIMIT 1
    </select>

    <select id="selectRateCodeComponent" resultMap="BaseResultMap">
        SELECT 
            rate_code_id, chain_id, hotel_id, rate_code, rate_code_name,
            description, market_code, channel_id, minlos, maxlos,
            minadv, maxadv, valid_from, valid_to, stay_start_date,
            stay_end_date, booking_start_date, booking_end_date,
            limit_start_time, limit_end_time, limit_avail_weeks,
            price_modifier, is_percentage, reservation_type,
            cancellation_type, latest_cancellation_days,
            latest_cancellation_time, cancellable_after_booking,
            order_retention_time, price_rule_type, parent_rate_code_id,
            created_at, updated_at
        FROM rate_codes
        WHERE hotel_id = #{hotelId}
        ORDER BY rate_code ASC
    </select>

    <select id="calendarByConditions" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM rate_codes
        WHERE hotel_id = #{hotelId}
        ORDER BY rate_code ASC
    </select>

    <select id="selectCalendarByHotelIdAndRateCode" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM rate_codes
        WHERE hotel_id = #{hotelId} AND rate_code = #{rateCode}
        ORDER BY rate_code ASC
    </select>

    <select id="bookingSelectByHotelRateCode" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM rate_codes
        WHERE hotel_id = #{hotelId} AND rate_code = #{rateCode}
        ORDER BY rate_code ASC
    </select>

    <select id="selectRoomTypesByRateCodeId" resultType="java.util.Map">
        SELECT DISTINCT
            rt.room_type_id,
            rt.room_type_code,
            rt.room_type_name,
            rt.description,
            rt.standard_price,
            rt.max_occupancy,
            rt.physical_inventory,
            rt.hotel_id,
            rt.chain_id
        FROM room_types rt
        INNER JOIN rate_plans rp ON rt.room_type_id = rp.room_type_id
        WHERE rp.rate_code_id = #{rateCodeId}
        ORDER BY rt.room_type_code ASC
    </select>

   

    <select id="selectRateCodesByHotelIdAndPriceRuleType" resultMap="BaseResultMap">
        SELECT
        rc.rate_code_id, rc.chain_id, rc.hotel_id, rc.rate_code, rc.rate_code_name, rc.description,
        rc.market_code, rc.channel_id, rc.minlos, rc.maxlos, rc.minadv, rc.maxadv, rc.limit_start_time,
        rc.limit_end_time, rc.price_modifier, rc.is_percentage, rc.valid_from, rc.valid_to,
        rc.reservation_type, rc.cancellation_type, rc.latest_cancellation_days,
        rc.latest_cancellation_time, rc.cancellable_after_booking, rc.order_retention_time,
        rc.stay_start_date, rc.stay_end_date, rc.booking_start_date, rc.booking_end_date, rc.created_at,
        h.hotel_name, rc.price_rule_type, rc.parent_rate_code_id
        FROM rate_codes rc
        LEFT JOIN hotels h ON rc.hotel_id = h.hotel_id
        WHERE rc.hotel_id = #{hotelId} AND rc.price_rule_type = '1'
        <if test="rateCodeId != null and rateCodeId != ''">
            AND rc.rate_code_id != #{rateCodeId}
        </if>
        ORDER BY rc.rate_code ASC
    </select>

    <select id="selectRateCodesByPriceRuleType" resultMap="BaseResultMap">
        SELECT
        rc.rate_code_id, rc.chain_id, rc.hotel_id, rc.rate_code, rc.rate_code_name, rc.description,
        rc.market_code, rc.channel_id, rc.minlos, rc.maxlos, rc.minadv, rc.maxadv, rc.limit_start_time,
        rc.limit_end_time, rc.price_modifier, rc.is_percentage, rc.valid_from, rc.valid_to,
        rc.reservation_type, rc.cancellation_type, rc.latest_cancellation_days,
        rc.latest_cancellation_time, rc.cancellable_after_booking, rc.order_retention_time,
        rc.stay_start_date, rc.stay_end_date, rc.booking_start_date, rc.booking_end_date, rc.created_at,
        h.hotel_name, rc.price_rule_type, rc.parent_rate_code_id
        FROM rate_codes rc
        LEFT JOIN hotels h ON rc.hotel_id = h.hotel_id
        WHERE rc.hotel_id = (SELECT hotel_id FROM rate_codes WHERE rate_code_id = #{rateCodeId})
        AND rc.price_rule_type = '1'
        AND rc.rate_code_id != #{rateCodeId}
        ORDER BY rc.rate_code ASC
    </select>

    <select id="selectRateCodesByHotelIdAndPriceRuleType2" resultMap="BaseResultMap">
        SELECT
        rc.rate_code_id, rc.chain_id, rc.hotel_id, rc.rate_code, rc.rate_code_name, rc.description,
        rc.market_code, rc.channel_id, rc.minlos, rc.maxlos, rc.minadv, rc.maxadv, rc.limit_start_time,
        rc.limit_end_time, rc.price_modifier, rc.is_percentage, rc.valid_from, rc.valid_to,
        rc.reservation_type, rc.cancellation_type, rc.latest_cancellation_days,
        rc.latest_cancellation_time, rc.cancellable_after_booking, rc.order_retention_time,
        rc.stay_start_date, rc.stay_end_date, rc.booking_start_date, rc.booking_end_date, rc.created_at,
        h.hotel_name, rc.price_rule_type, rc.parent_rate_code_id
        FROM rate_codes rc
        LEFT JOIN hotels h ON rc.hotel_id = h.hotel_id
        WHERE rc.hotel_id = #{hotelId} AND rc.price_rule_type = '2'
        AND rc.rate_code_id != #{rateCodeId}
        ORDER BY rc.rate_code ASC
    </select>

    <!-- 价格设置保存 -->
    <insert id="savePriceSettings" parameterType="com.zai.ratecode.dto.PriceSettingsSaveRequest">
        <!-- TODO: 实现价格设置保存逻辑 -->
        <!-- 这里需要根据具体的数据库表结构来实现 -->
        <!-- 可能涉及的表：rate_prices, price_history, room_type_prices等 -->
        INSERT INTO rate_prices (
            rate_code_id, room_type_id, base_price, adjusted_price, 
            currency, effective_date, expiry_date, price_type, 
            market_segment, channel_code, created_at, updated_at
        ) VALUES (
            #{request.rateCodeId}, #{request.priceSettings[0].roomTypeId}, 
            #{request.priceSettings[0].basePrice}, #{request.priceSettings[0].adjustedPrice},
            #{request.priceSettings[0].currency}, #{request.priceSettings[0].effectiveDate}, 
            #{request.priceSettings[0].expiryDate}, #{request.priceSettings[0].priceType},
            #{request.priceSettings[0].marketSegment}, #{request.priceSettings[0].channelCode},
            NOW(), NOW()
        )
    </insert>
    
    <!-- 插入价格记录到rate_prices表 -->
    <insert id="insertRatePrice" parameterType="map">
        INSERT INTO rate_prices (
            price_id, chain_id, hotel_id, hotel_code, rate_plan_id,
            room_type_id, room_type_code, rate_code_id, rate_code,
            stay_date, channel_single_occupancy, channel_double_occupancy,
            hotel_single_occupancy, hotel_double_occupancy,
            agent_single_occupancy, agent_double_occupancy,
            created_at, updated_at
        ) VALUES (
            #{priceData.priceId}, #{priceData.chainId}, #{priceData.hotelId}, #{priceData.hotelCode},
            #{priceData.ratePlanId}, #{priceData.roomTypeId}, #{priceData.roomTypeCode},
            #{priceData.rateCodeId}, #{priceData.rateCode}, #{priceData.stayDate},
            #{priceData.channelSingleOccupancy}, #{priceData.channelDoubleOccupancy},
            #{priceData.hotelSingleOccupancy}, #{priceData.hotelDoubleOccupancy},
            #{priceData.agentSingleOccupancy}, #{priceData.agentDoubleOccupancy},
            NOW(), NOW()
        )
    </insert>
    
    <!-- 批量插入价格记录到rate_prices表（按1000条分批调用） -->
    <insert id="insertRatePricesBatch" parameterType="java.util.List">
        INSERT INTO rate_prices (
            price_id, chain_id, hotel_id, hotel_code, rate_plan_id,
            room_type_id, room_type_code, rate_code_id, rate_code,
            stay_date, channel_single_occupancy, channel_double_occupancy,
            hotel_single_occupancy, hotel_double_occupancy,
            agent_single_occupancy, agent_double_occupancy,
            created_at, updated_at
        ) VALUES
        <foreach collection="priceDataList" item="item" separator=",">
            (
                #{item.priceId}, #{item.chainId}, #{item.hotelId}, #{item.hotelCode},
                #{item.ratePlanId}, #{item.roomTypeId}, #{item.roomTypeCode},
                #{item.rateCodeId}, #{item.rateCode}, #{item.stayDate},
                #{item.channelSingleOccupancy}, #{item.channelDoubleOccupancy},
                #{item.hotelSingleOccupancy}, #{item.hotelDoubleOccupancy},
                #{item.agentSingleOccupancy}, #{item.agentDoubleOccupancy},
                NOW(), NOW()
            )
        </foreach>
    </insert>
    
    <!-- 根据日期范围删除价格记录 -->
    <delete id="deleteRatePricesByDateRange" parameterType="map">
        DELETE FROM rate_prices 
        WHERE chain_id = #{deleteParams.chainId}
        AND hotel_id = #{deleteParams.hotelId}
        AND room_type_code = #{deleteParams.roomTypeCode}
        AND rate_code = #{deleteParams.rateCode}
        AND stay_date >= #{deleteParams.startDate} 
    </delete>
    
</mapper> 