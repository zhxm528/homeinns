<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zai.rateinventorystatus.mapper.RateInventoryStatusMapper">
    <!-- 结果映射 -->
    <resultMap id="BaseResultMap" type="com.zai.rateinventorystatus.entity.RateInventoryStatus">
        <id column="status_id" property="statusId"/>
        <result column="chain_id" property="chainId"/>
        <result column="hotel_id" property="hotelId"/>
        <result column="hotel_code" property="hotelCode"/>
        <result column="rate_plan_id" property="ratePlanId"/>
        <result column="room_type_id" property="roomTypeId"/>
        <result column="room_type_code" property="roomTypeCode"/>
        <result column="rate_code_id" property="rateCodeId"/>
        <result column="rate_code" property="rateCode"/>
        <result column="stay_date" property="stayDate"/>
        <result column="is_available" property="isAvailable"/>
        <result column="remaining_inventory" property="remainingInventory"/>
        <result column="sold_inventory" property="soldInventory"/>
        <result column="min_stay_days" property="minStayDays"/>
        <result column="max_stay_days" property="maxStayDays"/>
        <result column="min_advance_days" property="minAdvanceDays"/>
        <result column="max_advance_days" property="maxAdvanceDays"/>
        <result column="latest_cancel_days" property="latestCancelDays"/>
        <result column="latest_cancel_time_same_day" property="latestCancelTimeSameDay"/>
        <result column="payment_type" property="paymentType"/>
        <result column="latest_reservation_time_same_day" property="latestReservationTimeSameDay"/>
        <result column="is_cancellable" property="isCancellable"/>
        <result column="cancel_penalty" property="cancelPenalty"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
    </resultMap>
    
    <!-- 通用字段 -->
    <sql id="Base_Column_List">
        status_id, chain_id, hotel_id, hotel_code, rate_plan_id, room_type_id, room_type_code, rate_code_id, rate_code, stay_date, is_available, remaining_inventory, sold_inventory, min_stay_days, max_stay_days, min_advance_days, max_advance_days, latest_cancel_days, latest_cancel_time_same_day, payment_type, latest_reservation_time_same_day, is_cancellable, cancel_penalty, created_at, updated_at
    </sql>

    <!-- 插入 -->
    <insert id="insert" parameterType="com.zai.rateinventorystatus.entity.RateInventoryStatus">
        INSERT INTO rate_inventory_status (
            <include refid="Base_Column_List"/>
        ) VALUES (
            #{statusId}, #{chainId}, #{hotelId}, #{hotelCode}, #{ratePlanId}, #{roomTypeId}, #{roomTypeCode}, #{rateCodeId}, #{rateCode}, #{stayDate}, #{isAvailable}, #{remainingInventory}, #{soldInventory}, #{minStayDays}, #{maxStayDays}, #{minAdvanceDays}, #{maxAdvanceDays}, #{latestCancelDays}, #{latestCancelTimeSameDay}, #{paymentType}, #{latestReservationTimeSameDay}, #{isCancellable}, #{cancelPenalty}, #{createdAt}, #{updatedAt}
        )
    </insert>

    <!-- 更新 -->
    <update id="updateByPrimaryKey" parameterType="com.zai.rateinventorystatus.entity.RateInventoryStatus">
        UPDATE rate_inventory_status
        SET hotel_code=#{hotelCode}, rate_plan_id=#{ratePlanId}, room_type_id=#{roomTypeId}, room_type_code=#{roomTypeCode}, rate_code_id=#{rateCodeId}, rate_code=#{rateCode}, is_available=#{isAvailable}, remaining_inventory=#{remainingInventory}, sold_inventory=#{soldInventory}, min_stay_days=#{minStayDays}, max_stay_days=#{maxStayDays}, min_advance_days=#{minAdvanceDays}, max_advance_days=#{maxAdvanceDays}, latest_cancel_days=#{latestCancelDays}, latest_cancel_time_same_day=#{latestCancelTimeSameDay}, payment_type=#{paymentType}, latest_reservation_time_same_day=#{latestReservationTimeSameDay}, is_cancellable=#{isCancellable}, cancel_penalty=#{cancelPenalty}, updated_at=#{updatedAt}
        WHERE chain_id=#{chainId} AND hotel_id=#{hotelId} AND rate_code=#{rateCode} AND room_type_code=#{roomTypeCode} AND stay_date=#{stayDate}
    </update>

    <!-- 删除 -->
    <delete id="deleteByPrimaryKey">
        DELETE FROM rate_inventory_status
        WHERE chain_id=#{chainId} AND hotel_id=#{hotelId} AND rate_code=#{rateCode} AND room_type_code=#{roomTypeCode} AND stay_date=#{stayDate}
    </delete>

    <!-- 查询单条 -->
    <select id="selectByPrimaryKey" resultType="com.zai.rateinventorystatus.entity.RateInventoryStatus">
        SELECT <include refid="Base_Column_List"/>
        FROM rate_inventory_status
        WHERE chain_id=#{chainId} AND hotel_id=#{hotelId} AND rate_code=#{rateCode} AND room_type_code=#{roomTypeCode} AND stay_date=#{stayDate}
    </select>

    <!-- 条件分页查询 -->
    <select id="selectByCondition" resultType="com.zai.rateinventorystatus.entity.RateInventoryStatus">
        SELECT <include refid="Base_Column_List"/>
        FROM rate_inventory_status
        WHERE chain_id=#{chainId}
          AND hotel_id=#{hotelId}
          <if test="roomTypeCodeList != null and roomTypeCodeList.size > 0">
            AND room_type_code IN
            <foreach collection="roomTypeCodeList" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
          </if>
          <if test="rateCodeList != null and rateCodeList.size > 0">
            AND rate_code IN
            <foreach collection="rateCodeList" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
          </if>
          <if test="startDate != null and startDate != ''">
            AND stay_date &gt;= #{startDate}
          </if>
          <if test="endDate != null and endDate != ''">
            AND stay_date &lt;= #{endDate}
          </if>
          <if test="isAvailable != null and isAvailable != ''">
            AND is_available = #{isAvailable}
          </if>
          <if test="paymentType != null and paymentType != ''">
            AND payment_type = #{paymentType}
          </if>
        ORDER BY stay_date ASC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 条件统计 -->
    <select id="countByCondition" resultType="int">
        SELECT COUNT(1)
        FROM rate_inventory_status
        WHERE chain_id=#{chainId}
          AND hotel_id=#{hotelId}
          <if test="roomTypeCodeList != null and roomTypeCodeList.size > 0">
            AND room_type_code IN
            <foreach collection="roomTypeCodeList" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
          </if>
          <if test="rateCodeList != null and rateCodeList.size > 0">
            AND rate_code IN
            <foreach collection="rateCodeList" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
          </if>
          <if test="startDate != null and startDate != ''">
            AND stay_date &gt;= #{startDate}
          </if>
          <if test="endDate != null and endDate != ''">
            AND stay_date &lt;= #{endDate}
          </if>
          <if test="isAvailable != null and isAvailable != ''">
            AND is_available = #{isAvailable}
          </if>
          <if test="paymentType != null and paymentType != ''">
            AND payment_type = #{paymentType}
          </if>
    </select>

    <!-- 批量插入 -->
    <insert id="batchInsert">
        INSERT INTO rate_inventory_status (
            <include refid="Base_Column_List"/>
        ) VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.statusId}, #{item.chainId}, #{item.hotelId}, #{item.hotelCode}, #{item.ratePlanId}, #{item.roomTypeId}, #{item.roomTypeCode}, #{item.rateCodeId}, #{item.rateCode}, #{item.stayDate}, #{item.isAvailable}, #{item.remainingInventory}, #{item.soldInventory}, #{item.minStayDays}, #{item.maxStayDays}, #{item.minAdvanceDays}, #{item.maxAdvanceDays}, #{item.latestCancelDays}, #{item.latestCancelTimeSameDay}, #{item.paymentType}, #{item.latestReservationTimeSameDay}, #{item.isCancellable}, #{item.cancelPenalty}, #{item.createdAt}, #{item.updatedAt})
        </foreach>
    </insert>

    <!-- 批量更新（可根据实际需求优化） -->
    <update id="batchUpdate">
        <foreach collection="list" item="item" separator=";">
            UPDATE rate_inventory_status
            SET hotel_code=#{item.hotelCode}, rate_plan_id=#{item.ratePlanId}, room_type_id=#{item.roomTypeId}, room_type_code=#{item.roomTypeCode}, rate_code_id=#{item.rateCodeId}, rate_code=#{item.rateCode}, is_available=#{item.isAvailable}, remaining_inventory=#{item.remainingInventory}, sold_inventory=#{item.soldInventory}, min_stay_days=#{item.minStayDays}, max_stay_days=#{item.maxStayDays}, min_advance_days=#{item.minAdvanceDays}, max_advance_days=#{item.maxAdvanceDays}, latest_cancel_days=#{item.latestCancelDays}, latest_cancel_time_same_day=#{item.latestCancelTimeSameDay}, payment_type=#{item.paymentType}, latest_reservation_time_same_day=#{item.latestReservationTimeSameDay}, is_cancellable=#{item.isCancellable}, cancel_penalty=#{item.cancelPenalty}, updated_at=#{item.updatedAt}
            WHERE chain_id=#{item.chainId} AND hotel_id=#{item.hotelId} AND rate_code=#{item.rateCode} AND room_type_code=#{item.roomTypeCode} AND stay_date=#{item.stayDate}
        </foreach>
    </update>

    <!-- 根据日期范围删除 -->
    <delete id="deleteByDateRange">
        DELETE FROM rate_inventory_status
        WHERE chain_id=#{chainId} AND hotel_id=#{hotelId}
          AND stay_date &gt;= #{startDate} AND stay_date &lt;= #{endDate}
    </delete>

    <!-- 根据条件查询房价库存状态记录列表 -->
    <select id="calendarByConditions" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM rate_inventory_status
        WHERE hotel_id=#{hotelId}
          AND stay_date &gt;= #{startDate}
          AND stay_date &lt;= #{endDate}
          AND room_type_code IN
            <foreach collection="roomTypeCode" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        ORDER BY stay_date ASC
    </select>

    <update id="updateInventoryStatusByHotelRoomTypeRateCode">
        UPDATE rate_inventory_status
        SET is_available = #{isAvailable},
            remaining_inventory = #{remainingInventory},
            updated_at = #{updatedAt}
        WHERE chain_id = #{chainId}
          AND hotel_id = #{hotelId}
          AND room_type_code = #{roomTypeCode}
          AND rate_code = #{rateCode}
          AND stay_date = #{stayDate}
    </update>

    <select id="selectCalendarByHotelIdAndRoomTypeCodeAndRateCodeAndRatePlan" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM rate_inventory_status
        WHERE hotel_id = #{hotelId} 
        AND room_type_code = #{roomTypeCode} 
        AND rate_code = #{rateCode} 
        AND stay_date = #{stayDate}
    </select>

    <update id="updateByHotelIdAndRoomTypeAndRateCodeAndStayDate">
        UPDATE rate_inventory_status
        SET is_available = #{isAvailable}
        WHERE hotel_id = #{hotelId} 
        AND room_type_code = #{roomTypeCode} 
        AND rate_code = #{rateCode} 
        AND stay_date = #{stayDate}
    </update>

    <select id="selectByHotelIdAndRoomTypeAndRateCodeAndStayDate" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM rate_inventory_status
        WHERE hotel_id = #{hotelId} 
        AND room_type_code = #{roomTypeCode} 
        AND rate_code = #{rateCode} 
        AND stay_date = #{stayDate}
    </select>
</mapper> 