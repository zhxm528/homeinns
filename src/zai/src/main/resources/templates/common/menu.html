<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:fragment="head">
    <meta charset="UTF-8">
    <title>菜单</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- AdminLTE -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
    <!-- Bootstrap Select CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.18/dist/css/bootstrap-select.min.css" rel="stylesheet">
    <style>
        /* 导航栏容器样式 */
        .navbar {
            background: linear-gradient(135deg, #233876 0%, #1e88e5 100%);
            padding: 0;
        }
        
        .navbar > .container-fluid {
            max-width: 1400px;  /* 设置最大宽度 */
            margin: 0 auto;     /* 水平居中 */
            padding: 0 1rem;    /* 左右padding */
        }

        .navbar-custom-menu {
            margin-right: 10px;
        }
        
        .user-menu {
            padding: 5px 10px;
        }
        
        .user-menu .dropdown-toggle {
            color: #fff;
        }
        
        .user-menu .dropdown-toggle:hover {
            color: #f8f9fa;
        }
        
        .user-menu .dropdown-menu {
            border-radius: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .user-menu .dropdown-menu li a {
            padding: 8px 15px;
            color: #333;
        }
        
        .user-menu .dropdown-menu li a:hover {
            background-color: #f5f5f5;
        }
        
        .navbar-nav .nav-link {
            color: #fff !important;
            padding: 1rem 1.5rem;
        }
        
        .navbar-nav .nav-link:hover {
            background-color: rgba(255,255,255,0.1);
        }
        
        .navbar-nav .dropdown-menu {
            margin-top: 0;
            border: none;
            border-radius: 0;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .navbar-nav .dropdown-item {
            padding: 0.75rem 1.5rem;
            color: #333;
        }
        
        .navbar-nav .dropdown-item:hover {
            background-color: #f8f9fa;
        }
        
        .navbar-brand {
            color: #fff !important;
            padding: 0 1.5rem;
            font-weight: 600;
        }
        
        /* 简化酒店选择器样式 */
        .hotel-selector {
            margin: 0 1rem;
        }
        
        .hotel-selector .bootstrap-select {
            width: 200px !important;
        }
        
        .hotel-selector .bootstrap-select > .dropdown-toggle {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
            padding: 0.5rem 1rem;
            margin: 0.5rem 0;
        }
        
        .hotel-selector .bootstrap-select > .dropdown-toggle:hover,
        .hotel-selector .bootstrap-select > .dropdown-toggle:focus {
            background: rgba(255,255,255,0.2);
            outline: none !important;
            box-shadow: none !important;
        }
        
        .hotel-selector .bootstrap-select .filter-option {
            color: #fff;
        }
        
        .hotel-selector .dropdown-menu {
            margin-top: 0;
            padding: 0.5rem;
            border: none;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .hotel-selector .bs-searchbox input {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 0.5rem;
        }
        
        .hotel-selector .dropdown-item {
            padding: 0.5rem 1rem;
        }
        
        .hotel-selector .dropdown-item:hover {
            background-color: #f8f9fa;
        }

        /* 响应式布局调整 */
        @media (max-width: 1400px) {
            .navbar > .container-fluid {
                max-width: 100%;
            }
        }
    </style>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap Bundle JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- AdminLTE -->
    <script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
    <!-- Bootstrap Select -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.18/dist/js/bootstrap-select.min.js"></script>
    <script th:inline="javascript">
        // 确保在DOM完全加载后执行初始化
        $(document).ready(function() {
            console.log('DOM加载完成，开始初始化酒店选择器');
            // 确保Bootstrap-select已加载
            if ($.fn.selectpicker) {
                loadHotels();
            } else {
                console.error('Bootstrap-select 插件未加载');
            }
        });

        function initHotelSelector() {
            // 初始化 Bootstrap Select
            if ($('#hotelSelect').length > 0) {
                console.log('找到酒店选择器，开始初始化');
                
                try {
                    // 先销毁之前的实例
                    $('#hotelSelect').selectpicker('destroy');
                    
                    // 重新初始化
                    $('#hotelSelect').selectpicker({
                        liveSearch: true,
                        size: 10,
                        noneResultsText: '没有找到匹配的酒店',
                        liveSearchPlaceholder: '搜索酒店...',
                        width: '200px',
                        showTick: false,
                        dropupAuto: false,
                        mobile: false,
                        template: {
                            caret: '<span class="caret"></span>'
                        }
                    });

                    console.log('selectpicker初始化完成');
                } catch (error) {
                    console.error('selectpicker初始化失败:', error);
                }

                // 监听酒店选择事件
                $('#hotelSelect').off('changed.bs.select').on('changed.bs.select', function(e, clickedIndex, isSelected, previousValue) {
                    const selectedHotelId = $(this).val();
                    const currentHotelId = sessionStorage.getItem('selectedHotelId');
                    
                    // 只有当选择了新的酒店时才更新
                    if (selectedHotelId && selectedHotelId !== currentHotelId) {
                        updateSelectedHotel(selectedHotelId);
                    }
                });
            } else {
                console.log('未找到酒店选择器元素');
            }
        }

        function updateSelectedHotel(hotelId) {
            console.log('更新选中的酒店:', hotelId);
            // 检查是否与当前选中的酒店相同
            const currentHotelId = sessionStorage.getItem('selectedHotelId');
            if (hotelId === currentHotelId) {
                console.log('选中的酒店未变化，跳过更新');
                return;
            }

            $.ajax({
                url: '/api/session/hotel',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ hotelId: hotelId }),
                success: function(response) {
                    if (response.success) {
                        sessionStorage.setItem('selectedHotelId', hotelId);
                        console.log('酒店选择已更新');
                        
                        // 如果当前页面是需要刷新的页面，则刷新
                        const needRefreshPages = ['/roomtype', '/ratecode', '/goods'];
                        const currentPath = window.location.pathname;
                        if (needRefreshPages.includes(currentPath)) {
                            window.location.reload();
                        }
                    } else {
                        console.error('更新选中酒店失败:', response);
                        // 恢复之前的选择
                        $('#hotelSelect').selectpicker('val', currentHotelId);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('更新选中酒店失败:', error);
                    alert('更新选中酒店失败，请重试');
                    // 恢复之前的选择
                    $('#hotelSelect').selectpicker('val', currentHotelId);
                }
            });
        }

        function loadHotels() {
            console.log('开始加载酒店列表');
            
            // 移除之前的selectpicker实例和内容
            if ($('#hotelSelect').data('selectpicker')) {
                $('#hotelSelect').selectpicker('destroy');
            }
            // 移除所有生成的元素
            $('.hotel-selector .bootstrap-select').remove();
            
            $.ajax({
                url: '/api/hotels/current-chain',
                type: 'GET',
                success: function(response) {
                    console.log('收到酒店列表响应:', response);
                    if (response.success && response.data) {
                        const hotels = response.data;
                        console.log('解析到的酒店数据:', hotels);
                        
                        const select = $('#hotelSelect');
                        // 确保select元素存在
                        if (select.length === 0) {
                            console.error('未找到select元素');
                            return;
                        }
                        
                        // 清空现有选项
                        select.empty();
                        console.log('已清空现有选项');
                        
                        // 添加默认选项
                        const defaultOption = '<option value="">选择酒店</option>';
                        select.append(defaultOption);
                        console.log('已添加默认选项');
                        
                        // 添加酒店选项
                        hotels.forEach(function(hotel) {
                            const option = `<option value="${hotel.hotelId}">${hotel.hotelName}</option>`;
                            select.append(option);
                            console.log('添加酒店选项:', hotel.hotelName, hotel.hotelId);
                        });
                        
                        // 检查select中的选项
                        console.log('===== 检查select中的选项 =====');
                        console.log('select元素中的选项数量:', $('#hotelSelect option').length);
                        $('#hotelSelect option').each(function() {
                            console.log('选项:', {
                                text: $(this).text(),
                                value: $(this).val()
                            });
                        });
                        console.log('===== 检查结束 =====');

                        // 确保DOM更新后再初始化
                        setTimeout(function() {
                            // 初始化selectpicker
                            initHotelSelector();
                            
                            // 设置选中值
                            const savedHotelId = sessionStorage.getItem('selectedHotelId');
                            if (savedHotelId) {
                                $('#hotelSelect').selectpicker('val', savedHotelId);
                                console.log('已设置保存的酒店ID:', savedHotelId);
                            }
                            
                            console.log('酒店列表加载和初始化完成');
                        }, 100);
                    } else {
                        console.error('加载酒店列表失败:', response);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('加载酒店列表失败:', error);
                    console.error('状态:', status);
                    console.error('错误详情:', xhr);
                }
            });
        }
    </script>
</head>
<body>
    <header class="main-header" th:fragment="topMenu">
        <nav class="navbar navbar-expand-lg">
            <div class="container-fluid">
                <a href="/" class="navbar-brand">
                    <i class="fas fa-hotel me-2"></i>酒店管理系统
                </a>
                
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="/">
                                <i class="fas fa-home me-1"></i>首页
                            </a>
                        </li>
                        
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-building me-1"></i>集团管理
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="/hotel"><i class="fas fa-hotel me-2"></i>酒店管理</a></li>
                                <li><a class="dropdown-item" href="/user"><i class="fas fa-users me-2"></i>用户管理</a></li>
                            </ul>
                        </li>
                        
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-concierge-bell me-1"></i>酒店管理
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="/roomtype"><i class="fas fa-bed me-2"></i>房型管理</a></li>
                                <li><a class="dropdown-item" href="/ratecode"><i class="fas fa-tag me-2"></i>房价码</a></li>
                                <li><a class="dropdown-item" href="/goods"><i class="fas fa-shopping-cart me-2"></i>商品管理</a></li>
                            </ul>
                        </li>
                        
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-cogs me-1"></i>系统设置
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="/chain"><i class="fas fa-sitemap me-2"></i>集团设置</a></li>
                                <li><a class="dropdown-item" href="/channel"><i class="fas fa-random me-2"></i>渠道管理</a></li>
                                <li><a class="dropdown-item" href="/city"><i class="fas fa-city me-2"></i>城市管理</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="/system/settings"><i class="fas fa-sliders-h me-2"></i>系统设置</a></li>
                                <li><a class="dropdown-item" href="/system/logs"><i class="fas fa-history me-2"></i>系统日志</a></li>
                            </ul>
                        </li>
                    </ul>
                    
                    <div class="hotel-selector">
                        <select class="selectpicker" data-live-search="true" title="选择酒店" id="hotelSelect">
                        </select>
                    </div>
                    
                    <ul class="navbar-nav">
                        <li class="nav-item dropdown user-menu">
                            <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">
                                <i class="fas fa-user-circle me-1"></i>
                                <span class="hidden-xs" th:text="${session.userName}">用户名</span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="/profile"><i class="fas fa-user me-2"></i>个人信息</a></li>
                                <li><a class="dropdown-item" href="/password"><i class="fas fa-key me-2"></i>修改密码</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="/logout"><i class="fas fa-sign-out-alt me-2"></i>退出登录</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>
</body>
</html> 