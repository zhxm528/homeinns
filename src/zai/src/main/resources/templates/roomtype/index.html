<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <!-- 引入vmenu的头部，包含样式和脚本 -->
    <div th:replace="common/vmenu :: head"></div>
    <meta charset="UTF-8">
    <title>房型管理</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Bootstrap Table CSS -->
    <link href="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.css" rel="stylesheet">
    <!-- Bootstrap Select CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.18/dist/css/bootstrap-select.min.css" rel="stylesheet">
    <!-- AdminLTE CSS -->
    <link href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/common.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            margin: 0;
            padding: 0;
        }

        .v-content {
            margin-left: 250px;
            padding: 20px;
            transition: margin-left 0.3s ease-in-out;
        }

        @media (max-width: 768px) {
            .v-content {
                margin-left: 0;
            }
        }

        .main-content {
            flex: 1;
            padding: 20px;
        }

        .page-header {
            background: linear-gradient(135deg, #4361ee, #3f37c9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .page-header h2 {
            margin: 0;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            color: white;
        }

        .search-form {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            padding: 20px;
        }

        .table-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
        }

        .table {
            margin-bottom: 0;
        }

        .table thead th {
            background-color: #f8f9fa;
            border: none;
            color: #344767;
            font-size: 0.875rem;
            font-weight: 600;
            padding: 1rem;
            border-bottom: 2px solid #dee2e6;
            border-top: none;
            vertical-align: middle;
        }

        .table tbody td {
            border: none;
            padding: 1rem;
            vertical-align: middle;
            border-bottom: 1px solid #f1f1f1;
        }

        .table tbody tr:last-child td {
            border-bottom: none;
        }

        .table tbody tr {
            border-bottom: 1px solid #f1f1f1;
        }

        .table tbody tr:hover {
            background-color: #f3f4f6;
        }

        .btn-xs {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            border-radius: 0.2rem;
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4361ee;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- 引入垂直导航栏 -->
    <div th:replace="common/vmenu :: vmenu"></div>
    
    <!-- 主内容区域 -->
    <div class="v-content">
        <div class="main-content">
            <div class="container-fluid px-4">
                <div class="page-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2 class="mb-0"><i class="fas fa-bed me-2"></i>房型管理</h2>
                        <div class="hotel-selector">
                            <select class="selectpicker" data-live-search="true" title="选择酒店" id="hotelSelect">
                            </select>
                        </div>
                    </div>
                </div>

                <div class="search-form">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="searchRoomTypeName" placeholder="房型名称/房型代码">
                        </div>
                        <div class="col-md-8">
                            <button type="button" class="btn btn-primary" onclick="searchRoomTypes()">
                                <i class="fas fa-search me-1"></i>搜索
                            </button>
                            <button type="button" class="btn btn-success ms-2" onclick="showAddRoomTypeModal()">
                                <i class="fas fa-plus me-1"></i>新增
                            </button>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <table id="roomTypeTable" class="table">
                        <thead>
                            <tr>
                                <th data-field="hotelName">所属酒店</th>
                                <th data-field="roomTypeCode">房型代码</th>
                                <th data-field="roomTypeName">房型名称</th>
                                <th data-field="description">描述</th>
                                <th data-field="standardPrice">标准价格</th>
                                <th data-field="physicalInventory">物理库存</th>
                                <th data-field="operate" data-formatter="operateFormatter" data-align="center">操作</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加/编辑房型模态框 -->
    <div class="modal fade" id="roomTypeModal" tabindex="-1" role="dialog" aria-labelledby="roomTypeModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="roomTypeModalLabel">新增房型</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>所属集团：<span id="chainName" class="text-primary"></span></label>
                    </div>
                    <div class="form-group">
                        <label>所属酒店：<span id="hotelName" class="text-primary"></span></label>
                    </div>
                    <form id="roomTypeForm">
                        <input type="hidden" id="roomTypeId" name="roomTypeId">
                        <div class="form-group">
                            <label for="roomTypeName">房型名称</label>
                            <input type="text" class="form-control" id="roomTypeName" name="roomTypeName" required>
                        </div>
                        <div class="form-group">
                            <label for="description">描述</label>
                            <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="standardPrice">标准价格</label>
                            <input type="number" class="form-control" id="standardPrice" name="standardPrice" required>
                        </div>
                        <div class="form-group">
                            <label for="maxOccupancy">最大入住人数</label>
                            <input type="number" class="form-control" id="maxOccupancy" name="maxOccupancy" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveRoomType()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 加载动画 -->
    <div class="loading" style="display: none;">
        <div class="loading-spinner"></div>
    </div>

    <!-- JavaScript -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.18/dist/js/bootstrap-select.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
    <!-- 引入酒店选择器 -->
    <script th:src="@{/js/selecthotel.js}"></script>
    
    <script>
        let $table = $('#roomTypeTable');
        let $modal = $('#roomTypeModal');
        let isEdit = false;

        function showLoading() {
            $('.loading').fadeIn(200);
        }

        function hideLoading() {
            $('.loading').fadeOut(200);
        }

        function dateFormatter(value) {
            if (!value) return '';
            return new Date(value).toLocaleString();
        }

        $(document).ready(function() {
            console.log('页面加载完成，开始初始化...');
            // 初始化酒店选择器
            new HotelSelector('#hotelSelect');
            
            // 初始化模态框
            $('#roomTypeModal').on('show.bs.modal', function () {
                console.log('模态框即将显示');
            });
            
            $('#roomTypeModal').on('shown.bs.modal', function () {
                console.log('模态框已显示');
                // 验证表单值
                console.log('模态框显示后表单值验证:');
                console.log('roomTypeName:', $('#roomTypeName').val());
                console.log('description:', $('#description').val());
                console.log('standardPrice:', $('#standardPrice').val());
                console.log('maxOccupancy:', $('#maxOccupancy').val());
            });
            
            initTable();
        });

        function initTable() {
            console.log('开始初始化表格...');
            $table.bootstrapTable({
                url: '/api/roomtypes/list',
                method: 'get',
                queryParams: function(params) {
                    console.log('查询参数：', params);
                    return {
                        roomTypeName: $('#searchRoomTypeName').val()
                    };
                },
                responseHandler: function(res) {
                    console.log('服务器响应数据：', res);
                    if (res.success) {
                        return res.data;
                    }
                    return [];
                },
                pagination: true,
                sidePagination: 'client',
                pageSize: 10,
                pageList: [10, 25, 50, 100],
                search: false,
                showRefresh: false,
                showToggle: false,
                showColumns: false,
                toolbar: '#toolbar',
                formatNoMatches: function() {
                    return '没有符合条件的房型';
                },
                formatShowingRows: function(pageFrom, pageTo, totalRows) {
                    return '显示第 ' + pageFrom + ' 到第 ' + pageTo + ' 条记录，总共 ' + totalRows + ' 条记录';
                },
                onLoadSuccess: function(data) {
                    console.log('表格数据加载成功，数据：', data);
                },
                onLoadError: function(status, jqXHR) {
                    console.error('表格数据加载失败，状态码：', status, '错误信息：', jqXHR);
                }
            });
        }

        function operateFormatter(value, row) {
            return [
                '<button class="btn btn-xs btn-outline-primary" onclick="editRoomType(\'' + row.roomTypeId + '\')">',
                '<i class="fas fa-edit"></i>',
                '</button> ',
                '<button class="btn btn-xs btn-outline-danger" onclick="deleteRoomType(\'' + row.roomTypeId + '\')">',
                '<i class="fas fa-trash"></i>',
                '</button>'
            ].join('');
        }

        function searchRoomTypes() {
            $table.bootstrapTable('refresh');
        }

        function showAddRoomTypeModal() {
            $('#roomTypeModalLabel').text('新增房型');
            $('#roomTypeForm')[0].reset();
            $('#roomTypeId').val('');
            
            // 显示集团名称和酒店名称
            $.ajax({
                url: '/api/session/info',
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        $('#chainName').text(response.data.chainName || '未选择');
                        $('#hotelName').text(response.data.hotelName || '未选择');
                    }
                }
            });
            
            $('#roomTypeModal').modal('show');
        }

        function editRoomType(id) {
            showLoading();
            isEdit = true;
            console.log('开始获取房型数据，ID:', id);
            
            $.ajax({
                url: '/api/roomtypes/' + id,
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    console.log('服务器响应:', response);
                    
                    if (!response) {
                        console.error('服务器返回空响应');
                        alert('获取房型信息失败：服务器返回空响应');
                        return;
                    }
                    
                    // 检查响应格式
                    if (response.success === false) {
                        console.error('服务器返回错误:', response.message);
                        alert('获取房型信息失败：' + response.message);
                        return;
                    }
                    
                    // 获取实际数据
                    const data = response.data || response;
                    console.log('解析后的房型数据:', data);
                    
                    if (!data) {
                        console.error('房型数据为空');
                        alert('获取房型信息失败：房型数据为空');
                        return;
                    }
                    
                    // 设置表单值
                    $('#roomTypeId').val(data.roomTypeId || '');
                    $('#roomTypeName').val(data.roomTypeName || '');
                    $('#description').val(data.description || '');
                    $('#standardPrice').val(data.standardPrice || '');
                    $('#maxOccupancy').val(data.maxOccupancy || '');
                    
                    // 设置显示文本
                    $('#hotelName').text(data.hotelName || '未选择');
                    
                    // 获取集团信息
                    if (data.chainId) {
                        $.ajax({
                            url: '/api/chains/' + data.chainId,
                            type: 'GET',
                            dataType: 'json',
                            success: function(chainResponse) {
                                console.log('集团信息响应:', chainResponse);
                                const chainData = chainResponse.data || chainResponse;
                                $('#chainName').text(chainData.chainName || '未选择');
                            },
                            error: function(jqXHR) {
                                console.error('获取集团信息失败:', jqXHR);
                                $('#chainName').text('未选择');
                            }
                        });
                    } else {
                        $('#chainName').text('未选择');
                    }
                    
                    // 设置模态框标题
                    $('#roomTypeModalLabel').text('编辑房型');
                    
                    // 显示模态框
                    $('#roomTypeModal').modal('show');
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error('请求失败:', {
                        status: jqXHR.status,
                        statusText: jqXHR.statusText,
                        responseText: jqXHR.responseText,
                        textStatus: textStatus,
                        errorThrown: errorThrown
                    });
                    alert('加载房型信息失败：' + (jqXHR.responseText || errorThrown));
                },
                complete: function() {
                    hideLoading();
                }
            });
        }

        function deleteRoomType(id) {
            if (!confirm('确定要删除该房型吗？')) return;

            showLoading();
            $.ajax({
                url: '/api/roomtypes/' + id,
                type: 'DELETE',
                success: function() {
                    $table.bootstrapTable('refresh');
                },
                error: function(xhr, status, error) {
                    console.error('Error deleting room type:', error);
                    alert('删除失败：' + (xhr.responseText || '未知错误'));
                },
                complete: function() {
                    hideLoading();
                }
            });
        }

        function saveRoomType() {
            // 从服务器获取 Session 信息
            $.ajax({
                url: '/api/session/info',
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        var hotelId = response.data.hotelId;
                        if (!hotelId) {
                            alert('当前酒店为空，请先选择酒店后再操作房型');
                            return;
                        }

                        var roomTypeData = {
                            roomTypeId: $('#roomTypeId').val(),
                            roomTypeName: $('#roomTypeName').val(),
                            description: $('#description').val(),
                            standardPrice: $('#standardPrice').val(),
                            maxOccupancy: $('#maxOccupancy').val(),
                            hotelId: hotelId
                        };

                        // 根据是否有roomTypeId决定是新增还是编辑
                        var url = '/api/roomtypes';
                        var method = 'POST';
                        
                        if (roomTypeData.roomTypeId) {
                            url += '/' + roomTypeData.roomTypeId;
                            method = 'PUT';
                        }

                        $.ajax({
                            url: url,
                            type: method,
                            contentType: 'application/json',
                            data: JSON.stringify(roomTypeData),
                            success: function(response) {
                                $('#roomTypeModal').modal('hide');
                                $table.bootstrapTable('refresh');
                            },
                            error: function(xhr) {
                                alert('保存失败：' + xhr.responseText);
                            }
                        });
                    } else {
                        alert('获取会话信息失败：' + response.message);
                    }
                },
                error: function(xhr) {
                    alert('获取会话信息失败：' + xhr.responseText);
                }
            });
        }
    </script>
</body>
</html> 